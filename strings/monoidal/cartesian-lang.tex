\documentclass[10pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[margin=1in]{ geometry }
\usepackage{ xparse }

\usepackage{ kpfonts }

\usepackage{ amsmath }
\usepackage{ amssymb }
\usepackage{ amsthm }
\usepackage{ thmtools }
\usepackage{ stmaryrd }
\usepackage[T1]{ fontenc }

\usepackage{ tikz }
\usepackage{ tikz-cd }
\usepackage{ tikzit }
\usepackage{ svg }
\usepackage{ standalone }

\usepackage{ etoolbox }
\usepackage{ environ }

\usepackage[square, numbers]{ natbib }
\usepackage[colorlinks=true]{ hyperref }
\usepackage{ doi }

\bibliographystyle{abbrvnat}

\input{circuits.tikzstyles}
\usepackage{ macros }

\declaretheorem[title=Theorem]{theorem}
\declaretheorem[title=Definition, sibling=theorem]{definition}
\declaretheorem[title=Lemma, sibling=theorem]{lemma}
\declaretheorem[title=Example, sibling=theorem]{example}
\declaretheorem[title=Remark, sibling=theorem]{remark}
\declaretheorem[title=Proposition, sibling=theorem]{proposition}
\declaretheorem[title=Corollary, sibling=theorem]{corollary}

\NewEnviron{floating}{
    \centering
    \vspace{1em}
    \BODY

    \vspace{1em}
}

\newtoggle{graphcaps}
\newtoggle{graphinterfaces}
\newtoggle{stringtypes}
\newtoggle{stringcaps}

\togglefalse{stringtypes}
\toggletrue{graphinterfaces}

\svgpath{./svgs/.}

\title{A graph language for Cartesian categories}
\author{George Kaye}

\begin{document}
\maketitle

\section{Introduction}

\subsubsection*{Notation}

For sets $X, Y, Z$, subset $Y' \subseteq Y$ and function $\morph{f}{X}{Y}$, we can \emph{redirect} the function for a given output $y \in Y$ and $z \in Y' \cup Z$ with the notation $f' = \morph{f[y \mapsto z]}{X}{Y' \cup Z}$.
This has the effect $f'(x) = z$ if $f(x) = y$ and $f'(x) = f(x)$ otherwise. 

\section{Monoidal categories}\label{sec:monoidal-categories}

\toggletrue{stringtypes}
\togglefalse{stringcaps}

We begin by recapping the concepts of monoidal categories.
A category $\mcc$ is a collection of objects $A,B,C,...$ with morphisms $f,g,h,...$ between them. 
A morphism $f$ between objects $A$ and $B$ is denoted $\morph{f}{A}{B}$. 
The morphisms between each pair of objects $A \to B$ form a \emph{hom-set}, denoted $\mcc(A,B)$. 
Each object is equipped with an identity morphism $\morph{\id_A}{A}{A}$. 
Morphisms can be composed sequentially: if we have morphisms $\morph{f}{A}{B}$ and $\morph{g}{B}{C}$ we also have the morphism $\morph{f \seq g}{A}{C}$. 
Composition is associative ($f \seq (g \seq h) = (f \seq g) \seq h$) and unital ($\id \seq f = f = f \seq \id$).
In the language of string diagrams, we represent morphisms as boxes, and composition by horizontal juxtaposition.
The identity is drawn as an empty wire.
Equal morphisms in the category correspond to isomorphic diagrams -- `only connectivity matters'.

\begin{floating}
    \begin{tabular}{cccc}
        \rule[-1em]{0pt}{0pt}$\morph{f}{A}{B}$ & $\morph{g}{B}{C}$ & $\morph{f \seq g}{A}{C}$ & $\morph{\id[A]}{A}{A}$ \\
        \includestandalone{tikz/strings/category/f} &
        \includestandalone{tikz/strings/category/g} &
        \includestandalone{tikz/strings/category/composition} &
        \raisebox{0.4em}{\includestandalone{tikz/strings/category/identity}}
    \end{tabular}
\end{floating}

\noindent A \textit{monoidal} category \cite{joyal1991geometry} introduces a new binary operation known as the \textit{monoidal tensor}, denoted $- \tensor -$. 
The unit object of the monoid is denoted $I$.
Much like sequential composition, the tensor is associative ($(f \tensor g) \tensor h = f \tensor (g \tensor h)$) and unital with respect to the identity of the unit object ($\id[I] \tensor f = f = f \tensor \id[I]$).
When we write categorical terms, $\tensor$ binds tighter than $\seq$, so $f \tensor g \seq h \tensor k$ should be read as $(f \tensor g) \seq (h \tensor k)$.
Graphically, the tensor is drawn as vertical juxtaposition and the unit object is drawn as `empty space'.

\begin{floating}
    \begin{tabular}{cccc}
        \rule[-1em]{0pt}{0pt}$\morph{f}{A}{B}$ & $\morph{g}{C}{D}$ & $\morph{f \tensor g}{A \tensor C}{B \tensor C}$ & $\morph{\id[I]}{I}{I}$ \\
        \includestandalone{tikz/strings/monoidal/f} &
        \includestandalone{tikz/strings/monoidal/g} &
        \raisebox{-1.25em}{\includestandalone{tikz/strings/monoidal/tensor}} &
        \includestandalone{tikz/strings/monoidal/empty}
    \end{tabular}
\end{floating}

\noindent The addition of tensor means that there are multiple ways in which we can compose morphisms in sequence or in parallel that lead to equal terms.
This is known as \emph{functoriality}, and can be expressed as the following axiom: $(f \seq g) \tensor (h \seq k) = f \tensor h \seq g \tensor k$.
Functoriality means that using the one dimensional algebraic notation can obfuscate the true nature of the inherently two dimensional structure.
This is especially important computationally, as numerous extra operations must be performed to manipulate a term appropriately.
Fortunately, the graphical notation eliminates this overhead, as both terms correspond to the same diagram:

\begin{floating}
    \includestandalone{tikz/strings/monoidal/functoriality}
\end{floating}

\section{Hypergraphs}

We begin by recalling the definition of a \emph{directed hypergraph}, where edges can have multiple \emph{sources} and \emph{targets}.

\begin{definition}[Directed hypergraph]
    A hypergraph consists of
    \begin{itemize}
        \item A finite set $V \subset \atoms$ of \emph{vertices}.
        \item For each $k,l \in \nat$, a (possibly empty) set $E^{k,l} \subset \atoms$ of \emph{edges} with $k$ sources and $l$ targets.
        \item For each $i < k \in \nat$, a function $\morph{\esources^i}{E_{k,l}}{V}$ representing the $i$th \emph{source map}.
        \item For each $i < l \in \nat$, a function $\morph{\esources^j}{E_{k,l}}{V}$ representing the $j$th \emph{target map}.
    \end{itemize}
\end{definition}

\noindent For a given vertex $v$, we say that its \emph{in-degree} $\ind{v}$ is the number of edges it is the target of, and dually its \emph{out-degree} $\oud{v}$ is the number of edges it is the source of.
We can also label hypergraphs according to a \emph{monoidal signature} of generators with associated domains and codomains, where an edge $e \in E_{k,l}$ can be labelled with a generator $\phi$ if $\dom{\phi} = k$ and $\cod{\phi} = l$.

It will be useful to characterise hypergraphs as a \emph{functor category}~\cite{bonchi2016rewriting}.
Firstly, we note that we can represent a monoidal signature $\Sigma$ as a directed hypergraph, with a single vertex and edges for each generator in the signature, with the vertex appearing the appropriate amount of times in the sources and targets of each edge.
This will allow us to represent the labelling of hypergraphs using a \emph{slice category}.

\begin{definition}[Category of hypergraphs]
    Let $\hyp$ be the functor category $[\textbf{X}, \textbf{Set}]$, where $\textbf{X}$ has as as objects pairs of natural numbers $(k,l)$ for each $k,l \in \nat$ and an extra object $\star$.
    For each object $x = (k,l)$, there are $k + l$ arrows from $x$ to $\star$.
    Let $\labhyp = \hyp / \hypsig$ be the slice category over a hypergraph signature $\hypsig$.
\end{definition}

\subsection{Partial hypergraphs}

Hypergraphs have been shown to be a suitable language for rewriting in settings equipped with a \emph{Frobenius structure}~\cite{bonchi2016rewriting}.
In these settings, wires in string diagrams can fork arbitrarily.
It has also been shown that the \emph{monogamous} hypergraphs, i.e. those where each vertex has at most in and out-degree $1$, can be used for rewriting in a plain symmetric monoidal setting without such Frobenius structure.
However, we are interested in an intermediate notion: one where we only have a \emph{Cartesian} structure.
For this reason we define a notion of hypergraphs we call \emph{partial hypergraphs}.
Intuitively, this means that each vertex can have at most in-degree $1$, but an arbitrary out-degree.

\begin{definition}[Partial hypergraph]
    A partial hypergraph consists of
    \begin{itemize}
        \item A finite set $\vertices \subset \atoms$ of \emph{vertices}.
        \item A finite set $\edges \subset \atoms$ of \emph{edges}.
        \item A function $\morph{\esources}{\edges}{\vertices^\mon}$, representing the \emph{sources} of each edge. 
        \item A subset $\etargets \subseteq V$, partitioned into $|\edges|$ totally ordered parts, representing the \emph{targets} of each edge.
    \end{itemize}
\end{definition}

This definition ensures that each vertex can be the target of at most one edge.
To correspond with the notation for sources, we still write $\etargets(e)$ to obtain the relevant ordered part, and we will also use the shorthand $\esources^i$ and $\etargets^j$ to denote the corresponding elements of the list and set.
Again, we can label edges with labels from a monoidal signature if their have an appropriate number of sources and targets. 
We define the category with objects the labelled partial hypergraphs and morphisms the partial hypergraph homomorphisms as $\lphyp$.
It is fairly simple to see that our category $\lphyp$ forms a full subcategory of $\labhyp$.

\begin{definition}[Inclusion functor]
    The inclusion functor $\morph{I}{\phyp}{\hyp}$ is defined for a partial hypergraph as the identity on vertices, mapping each edge $e$ for which $|\esources(e)| = k$ and $|\etargets(e)| = l$ to an edge in $E_{k,l}$, and 
    \begin{gather*}
        V_H = V_F \qquad 
        E^{k,l}_H = \{ e \ |\ e \in E_F,\ |\esources_F(e)| = k,\ |\etargets_F(e)| = l\} \qquad
        \esources_H^i(e) = \proj{i}(\esources_F(e)) \qquad
        \etargets_H^j(e) = \proj{j}(\etargets_F(e))
    \end{gather*}
\end{definition}

\begin{proposition}
    $\phyp$ is a full subcategory of $\hyp$ with injection functor $I$.
\end{proposition}
\begin{proof}
    The notion of morphism in $\phyp$ and $\hyp$ is the same: sources and targets must be preserved.
    Therefore any morphism between graphs in $\hyp$ must also be a morphism in $\phyp$.
\end{proof}

The case is the same for the labelled versions.
As we have previously mentioned, $\phyp$ is the full subcategory of $\hyp$ in which each vertex has in-degree of at most $1$ but an arbitrary out-degree.

\subsection{Cospans}

To represent the interfaces of our hypergraphs we can use \emph{ordered cospans}.
We wish to use the left leg of the cospan as the \emph{inputs} to the hypergraph and the right leg as the \emph{outputs}.

\begin{definition}[Categories of cospans~\cite{bonchi2020string}]\label{def:cospans}
    For a finitely cocomplete category $\mcc$, a \emph{cospan} from $X \to Y$ is a pair of arrows $X \to A \leftarrow Y$.
    A \emph{cospan morphism} $(X \to A \leftarrow Y) \to (X \to B \leftarrow Y)$ is a morphism in $C \to D \in \mcc$ such that the following diagram commutes: 
    
    \begin{center}
        \includestandalone{tikz/graphs/morphism}
    \end{center}
    
    Two cospans $\cospan{X}{A}{Y}$ and $\cospan{X}{B}{Y}$ are \emph{isomorphic} if there exists a morphism of cospans as above where $\alpha$ is an isomorphism.
    Composition is by pushout:

    \begin{center}
        \includestandalone{tikz/graphs/composition}
    \end{center}

    The identity is $X \xrightarrow{\id[X]} X \xleftarrow{\id[X]} X$.
    Then, the category of cospans over $\mcc$, denoted $\csp{\mcc}$ has as objects the objects of $\mcc$ and as morphisms the isomorphism classes of cospans.
    This category has monoidal product given by the coproduct in $\mcc$ with unit the initial object $0 \in \mcc$.
\end{definition}

We are interested in a particular class of cospans that we can use for modelling terms in a traced Cartesian category.
Firstly, the left and right legs of the cospan serve only to `pick' the inputs and outputs, so we must restrict to the cospans $\cospan{M}{F}{N}$ where $M$ and $N$ only have vertices: they are \emph{discrete}.

\begin{definition}[Discrete hypergraph]
    For any $n \in \nat$, we write a discrete hypergraph of $n$ vertices as $n \in \phyp$ where $V_n = \{v_i \ |\ i \in \nat < n\}$, $E = \emptyset$, $\esources_n = \emptyset$ and $\etargets_n = \emptyset$.  
\end{definition}

In particular, observe the the discrete hypergraph $0$ with no vertices is the initial object in $\phyp$ (and $\hyp$).
We write $\inds{v}$ and $\ouds{v}$ for the in and out degree of a vertex $v$ added to the number of times they are in the image of $f$ or $g$ respectively.

Moreover, we must be careful with which vertices the cospans pick.
On the left, the cospan must pick only the `open' vertices, and must leave no dangling vertices.
Conversely on the right we have no such restriction, as we may wish to copy or discard outgoing data.
Moreover, we must enforce that a vertex with in-degree $0$ must also have out-degree $0$: this ensures we cannot \emph{introduce} wires arbitrarily. This is only permitted with a cocartesian structure.

\begin{definition}[Partial monogamy]
    We say that a cospan $\cospanx{m}{f}{F}{g}{n}$ is \emph{partial monogamous} if $f$ is injective and for all vertices $v \in V_F$ 
    \[\ind{v} = \begin{cases}
        0 & \text{if}\ v \in \inputs{F} \\
        1 & \text{otherwise}
    \end{cases}
    \qquad
    \oud{v} = \begin{cases}
        0 & \text{if}\ v \in \outputs{F} \vee v \not\in \inputs{F} \\
        n & \text{otherwise}
    \end{cases}\]
\end{definition}

For a partial monogamous cospan $\cospanx{m}{f}{F}{g}{n}$, we refer to the image of $f$ as the \emph{inputs} of the hypergraph $\inputs{F}$ and the image of $g$ as the \emph{outputs} of the hypergraph $\outputs{F}$.
We write $f^i \in \vertices_F$ for the $i$th input vertex of $F$ and $g^j \in \vertices_F$ for the $j$th output vertex.

All cospans will now be assumed to be partial monogamous.

\begin{center}
    \includestandalone{tikz/graphs/example}
\end{center}

\subsection{Operations}

\subsubsection{Composition}

As we have established in Definition~\ref{def:cospans}, composition of cospans can be performed by pushout.

\begin{center}
    $\cospanx{m}{f}{F}{g}{n} \quad \seq \quad \cospanx{n}{h}{G}{k}{p} \quad = \quad \cospanx{m}{f}{F +_{g,h}}{k}{p}$ 

    \vspace{1em}

    \includestandalone[scale=0.45]{tikz/graphs/f} \
    \raisebox{1.3em}{$\seq$} \
    \includestandalone[scale=0.45]{tikz/graphs/g} \
    \raisebox{1.3em}{$=$} \
    \includestandalone[scale=0.45]{tikz/graphs/seq}
\end{center}

\noindent This can be described concretely as follows.

\begin{definition}[Composition]
    For $\cospanx{m}{f}{F}{g}{n}$ and $\cospanx{n}{h}{G}{k}{p} \in \mcspdphyp$, their composition is $\cospanx{m}{f'}{H}{k'}{p}$ where 
    \begin{gather*}
        V_H = V_F - \outputs{F} + V_G - \inputs{G} + \{v_i \ |\ i < n, v_i \text{ fresh in } \atoms\} \qquad
        E_H = E_F + E_G \\
        \esources_H = \esources_F + \esources_G[\inputs{i}{G} \mapsto v_i] \qquad \etargets_H = \etargets_H = \etargets_F[\outputs{i}{F} \mapsto v_i] + \etargets_G \\
        f' = f[\outputs[i]{F} \mapsto v_i] \qquad
        k' = k[\inputs[i]{G} \mapsto v_i]
    \end{gather*}
\end{definition}

\begin{proposition}
    For any partial monogamous cospans $\cospanx{m}{f}{F}{g}{n}$ and $\cospanx{n}{h}{G}{k}{p}$ then $\cospanx{m}{f}{F}{g}{n} \seq \cospanx{n}{h}{G}{k}{p}$ is also partial monogamous.
\end{proposition}
\begin{proof}
    Each input in $G$ will be `glued' to an output in $F$.
    By the partial monogamy condition, for each input $v \in \inputs{G}$, $\ind{v} = 0$ and for each output $v \in \outputs{G}$, $\oud{v} = 0$.
    Therefore the in-degrees of the glued vertices will be provided solely by $F$ and the out-degrees provided solely by $G$.
    As these vertices satisfy the partial monogamy condition, so will the glued vertices.
    Moreover, since there is a one-to-one mapping between outputs and the glued vertices, the left leg of the cospan will still be injective.
\end{proof}

\begin{definition}[Identity]
    The identity of $n$, denoted $\id[n]$, is the cospan $\cospanx{n}{f}{n}{f}{n}$, where $f(\vertices^i_n) = \vertices^i_n$.
\end{definition}

\begin{center}
    \includestandalone[scale=0.45]{tikz/graphs/identity}
\end{center}

\begin{proposition}\label{prop:identity-pm}
    The identity on $n$ $\cospanx{n}{f}{n}{f}{n}$ is partial monogamous.
\end{proposition}
\begin{proof}
    Every vertex in $n$ is in the image of the left and right leg of the cospan and has in-degree and out-degree $0$.
    The function $f$ is defined to be injective.
\end{proof}

\subsubsection{Tensor}

Similarly, we can define monoidal tensor using the coproduct.

\begin{center}
    $\cospanx{m}{f}{F}{g}{n} \quad \tensor \quad \cospanx{p}{h}{G}{k}{q} \quad = \quad \cospanx{m+n}{f+h}{F + G}{g+k}{p+q}$ 

    \vspace{1em}

    \includestandalone[scale=0.5]{tikz/graphs/f} \
    \raisebox{1.4em}{$\tensor$} \
    \includestandalone[scale=0.5]{tikz/graphs/g} \
    \raisebox{1em}{$=$} \
    \raisebox{-1em}{\includestandalone[scale=0.5]{tikz/graphs/par}}
\end{center}

\begin{definition}[Tensor]
    For $\cospanx{m}{q}{F}{r}{n}$ and $\cospanx{m'}{s}{G}{t}{n'} \in \mcspdphyp$, their tensor is $\cospanx{m+n}{f+h}{F + G}{g+k}{p+q}$ where
    \begin{gather*}
        V_H = V_F + V_G \qquad E_H = E_F + E_G \qquad \esources_H = \esources_F + \esources_G \qquad \etargets_H = \etargets_F + \etargets_G
    \end{gather*}
\end{definition}

\begin{definition}[Empty]
    The empty graph is the cospan $\cospan{0}{0}{0}$.
\end{definition}

\begin{center}
    \includestandalone[scale=0.45]{tikz/graphs/empty}
\end{center}

\begin{proposition}
    For any partial monogamous cospans $\cospanx{m}{f}{F}{g}{n}$ and $\cospanx{n}{h}{G}{k}{p}$ then $\cospanx{m}{f}{F}{g}{n} \tensor \cospanx{n}{h}{G}{k}{p}$ is also partial monogamous.
\end{proposition}
\begin{proof}
    The degree of vertices is not affected by the tensor as it is simply the coproduct.
    Similarly, the left leg of the cospan is still injective as it is just the coproduct of two injective functions $f$ and $h$.
\end{proof}

\subsubsection{Symmetry}

\begin{center}
    \includestandalone[scale=0.5]{tikz/graphs/symmetry}
\end{center}

\begin{definition}[Symmetry]
    The symmetries $\swap{0}{n}$ and $\swap{n}{0}$ are defined as the identity $\id[n]$.
    The symmetry $\swap{1}{1}$ is defined as the cospan $\cospanx{2}{f}{2}{g}{2}$, where $f(\proj{i}(\vertices_2)) = \proj{i}(\vertices_2)$, $g(\proj{0}(\vertices_2) = \proj{1}(\vertices_2))$ and $g(\proj{1}(\vertices_2) = \proj{0}(\vertices_2))$.
    We define larger symmetries as $\swap{1}{n + 1} = \swap{1}{n} \tensor \id[1] \seq \id[n] \tensor \swap{1}{1}$, $\swap{m + 1}{1} = \id[m] \tensor \swap{1}{1} \seq \swap{m}{1} \tensor \id[1]$ and $\swap{m + 1}{n + 1} = \id[m] \tensor \swap{1}{n} \tensor \id[1] \seq \swap{m}{n} \tensor \swap{1}{1} \seq \id[n] \tensor \swap{m}{1} \tensor \id[1]$. 
\end{definition}

\begin{proposition}
    The symmetry $\swap{m}{n}$ is partial monogamous.
\end{proposition}
\begin{proof}
    As with identity (Proposition \ref{prop:identity-pm}).
\end{proof}

%\subsubsection{Homeomorphism}

%We might not need this!

%\begin{center}
%    \raisebox{-0.65em}{\includestandalone[scale=0.5]{tikz/graphs/identity}} \
%    \scalebox{1.5}{$\homeo$} \
%    \raisebox{-1.05em}{\includestandalone[scale=0.5]{tikz/graphs/id-edge}} \
%\end{center}

%To admit homeomorphism into our graphs, we add the notion of \emph{identity edges}, the set of which is denoted $\edges^{\id}_F$ for a given hypergraph $F$.
%We extend the source and target functions to also operate on these edges.

%\begin{definition}[Expansion]
%    For a cospan of partial hypergraphs $\cospanx{m}{f}{F}{g}{n}$ and vertex $v \in \vertices_F$, an \emph{expansion on $v$} is defined as $\cospanx{m}{f'}{H}{g'}{n}$ where
%    \begin{gather*}
%        \vertices_H = \vertices_F - v + v_a + v_b \qquad
%        \edges_H = \edges_F \qquad \idedges_H = \idedges_F + e_{\id} \qquad 
%        v_a, v_b, e \text{ fresh in } \atoms \\
%        \esources_H(e \in \edges_F + \idedges_F) = \esources_F[v \mapsto v_b] \qquad \esources_H(e_{\id}) = [v_a] \qquad
%        \etargets_H(e \in \edges_F + \idedges_F) = \esources_F[v \mapsto v_a] \qquad \etargets_H(e_{\id}) = \{v_b\} \\
%        f' = f[v \mapsto v_a] \qquad
%        g' = g[v \mapsto v_b]
%    \end{gather*} 
%\end{definition}

%\begin{definition}[Smoothing]
%    For a cospan of partial hypergraphs $\cospanx{m}{f}{F}{g}{n}$ where $F$ contains an identity edge $e \in \idedges$ with source $v_a$ and target $v_b$, a \emph{smoothing on $e$} is defined as $\cospanx{m}{f'}{H}{g'}{n}$ where
%    \begin{gather*}
%        \vertices_H = \vertices_F - v_a - v_b + v \quad v \text{ fresh in } \atoms \qquad
%        \edges_H = \edges_F \qquad \idedges_H = \idedges_F - e \\
%        \esources_H = \esources_F[v_a \mapsto v, v_b \mapsto v] \qquad
%        \etargets_H = \etargets_F[v_a \mapsto v] \qquad
%        f' = f[v_a \mapsto v] \qquad
%        g' = f[v_a \mapsto v, v_b \mapsto v]
%    \end{gather*}    
%\end{definition}


\subsubsection{Trace}

To take the trace of $k$ on a cospan of hypergraphs, we join together the first $k$ inputs and outputs, creating a loop.
When we are taking the trace where the input and output are the same vertex, then this has the effect of simply detaching them from the interface.
This means a closed loop is represented as a lone vertex.

\begin{center}
    \includestandalone[scale=0.5]{tikz/graphs/f} \
    \raisebox{1.5em}{$\xrightarrow{\trace{1}{-}}$} \
    \includestandalone[scale=0.5]{tikz/graphs/trace}

    \vspace{1em}

    \includestandalone[scale=0.5]{tikz/graphs/identity} \
    \raisebox{1.5em}{$\xrightarrow{\trace{1}{-}}$} \
    \includestandalone[scale=0.5]{tikz/graphs/trace-id}
\end{center}

\begin{definition}[Trace]
    For a cospan of partial hypergraphs $\cospanx{x + m}{h + f}{F}{k + g}{x + n}$, its trace of $x$ wires is defined inductively on $x$, with the zero case defined as $\trace{0}{\cospan{m}{F}{n}} = \cospan{m}{F}{n}$, the inductive case defined as $\trace{k + 1}{\cospan{k + 1 + m}{F}{k + 1 + n}} = \trace{1}{\trace{k}{\cospan{k + 1 + m}{F}{k + 1 + n}}}$ and the base case defined as $\trace{1}{\cospan{k + m}{f+h}{F}{g+l}{k + n}} = \cospanx{m}{h}{H}{k}{n}$ where
    \begin{gather*}
        \vertices_H = \vertices_F - \inputs[0]{F} - \outputs[0]{F} + v_t \qquad \edges_H = \edges_F \qquad
        \esources_H = \esources_F[\inputs[0]{F} \mapsto v_t] \qquad \etargets_H = \etargets_F[\outputs[0]{F} \mapsto v_t]
    \end{gather*}
\end{definition}

\begin{proposition}
    For any partial monogamous cospan $\cospanx{k + m}{f + g}{F}{h + l}{k + n}$, $\trace{k}{\cospanx{k + m}{f + g}{F}{h + l}{k + n}}$ is also partial monogamous.
\end{proposition}
\begin{proof}
    Tracing a hypergraph glues together the first $k$ inputs and outputs.
    By the partial monogamous condition, the in-degree of the inputs and the out-degree of the outputs is $0$.
    Therefore, the glued vertex will only have the out-degree of the outputs and the in-degree of the inputs, both of which satisfy the partial monogamy condition.
    Since the left leg of the cospan is simply the function $g$, it must be injective.
\end{proof}

\subsubsection{Cartesian structure}

We now turn our attention to adding the cartesian structure to our language. 
Recall that this can be achieved by introducing families of natural \emph{copy} and \emph{discard} maps.

\begin{center}
    \toggletrue{stringtypes}
    \includestandalone{tikz/strings/cartesian/copy}
    \includestandalone{tikz/strings/cartesian/discard}
\end{center}

The copy and delete morphisms can both be represented as a single vertex, with appropriate interface cospans.

\begin{center}
    \includestandalone[scale=0.45]{tikz/graphs/copy}
    \qquad
    \raisebox{0.5em}{\includestandalone[scale=0.45]{tikz/graphs/operations/discard}}
\end{center}

\begin{definition}[Copy]
    The copy on $n$, denoted $\ccopy{n}$, is defined as $\cospanx{n}{f}{n}{f + f}{n}$.
\end{definition}

\begin{definition}[Discard]
    The discard on $n$, denoted $\cdel{n}$, is defined as $\cospanx{n}{f}{n}{}{0}$.
\end{definition}

With this encoding, we can absorb the cocommutative comonoid axioms and the coherence axioms.

\begin{proposition}
    With the above encodings of the copy and discard morphisms, $\pmcspdphyp$ satisfies the cocommutative comonoid axioms:

    \begin{center}
        \toggletrue{stringtypes}
        \begin{tabular}{l l}
            $\ccopy{n} = \ccopy{n} \seq \swap{m}{n}$ & (cocommutativity) \\
            $\ccopy{n} \seq \ccopy{n} \tensor \id[n] = \id[n]$ & (coassociativity) \\
            $\ccopy{n} \seq \cdel{n} \tensor \id[n]$ & (left counitality) \\
            $\ccopy{n} \seq \id[n] \tensor \cdel{n} = \id[n]$ & (right counitality)
        \end{tabular}

        \vspace{1em}

        \includestandalone{tikz/strings/cartesian/cocommutativity}
        \
        \raisebox{-0.5em}{\includestandalone{tikz/strings/cartesian/coassociativity}}
        \
        \includestandalone{tikz/strings/cartesian/left-counitality}
        \
        \includestandalone{tikz/strings/cartesian/right-counitality}
    \end{center}
\end{proposition}
\begin{proof}
    For cocommutativity, the right leg of the cospan picks the same vertex regardless of the order, so the two are isomorphic.
    For coassociativity, both expressions evaluate to a single vertex which is picked by three legs on the right.
    For counitality, the lack of right leg on the discard graph means that both expressions reduce to a single vertex picked by $n$ vertices on the left and right: an identity graph.
\end{proof}

\begin{proposition}
    With the above encodings of the copy and discard morphisms, $\pmcspdphyp$ satisfies the coherence axioms:
    \begin{center}
        \begin{tabular}{l l}
            $\ccopy{0} = \id[0]$ & (empty copy) \\
            $\cdel{0} = \id[0]$ & (empty discard) \\
            $\ccopy{m + n} = \ccopy{m} \tensor \ccopy{n} \seq \id[m] \tensor \swap{m}{n} \tensor \id[n]$ & (composite copy) \\
            $\cdel{m + n} = \cdel{m} \tensor \cdel{n}$ & (composite discard)
        \end{tabular}
    \end{center}
\end{proposition}
\begin{proof}
    The empty copy and discard are graphs with no vertices, so are the empty graph.
    For composite copy, the right leg of the cospan has two stacks of $m + n$ vertices, one ordered before the other.
    The $i$th vertex in each stack picks the same vertex, so this corresponds to the use of the symmetry.
    For composite discard, the expression on the left evaluates to a graph with $m + n$ vertices that are not picked by the output cospan.
\end{proof}

\subsection{Naturality}

We cannot absorb the axioms of naturality into our framework, as they involve the actual copying of edges.
We must therefore introduce them as families of rewrite rules.

\begin{center}
    \includestandalone[scale=0.45]{tikz/dpo/copy}
    \qquad
    \raisebox{0.5em}{\includestandalone[scale=0.4]{tikz/dpo/discard}}
\end{center}

\noindent Observe that the copy rule is \emph{not} left-linear: its left leg is not mono!
This means that the pushout complement will not be unique.
However this is not an issue: the set of pushout complements for a pair of morphisms $K \to L \to G$ is finite whenever $K$, $L$ and $G$ are, so we can enumerate them~\cite{heumuller2011construction,bonchi2020string}.
With a Frobenius structure, all these pushouts are valid.
However in our traced Cartesian setting this is not necessarily the case.

The crux is we \emph{must} expan

\section{Future work}

If we reflect everything horizontally we can obtain a graph language for traced coproduct categories, with a \emph{merge map} $\cmerge{}$ and an \emph{init map} $\cinit{}$.
These categories correspond to \emph{control flow}~\cite{selinger2010survey}, and admit an \emph{iteration operator}.
However, we would not be able to combine these two languages to create a suitable language for \emph{biproducts}, as this would return to the original definition of `vanilla' hypergraphs, which admits a Frobenius structure~\cite{bonchi2016rewriting}.
Combining the unit of the product and coproduct would also mean we could not use a dangling vertex picked by neither the input or output interface as a closed loop, as this would instead be the composition of the two units.
Under some axiomatisations this is the case, and $\trace{X}{\id[X]} = \id[I] = \cinit{} \seq \cdel{}$ \emph{does} hold, but this is not always the case. 
If we place an \emph{acyclicity} condition on the graph, we obtain a result for Cartesian categories \emph{without} a traced structure.

\bibliography{refs}

\end{document}